<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Beagle: Food Frenzy</title>
<style>
  :root{
    --skyTop:#7ecbff; --skyMid:#a9ddff;
    --grass1:#62ce66; --grass2:#3aa64a;
    --pillOn:#00c853; --pillOff:#d2d2d2;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;height:100%;background:var(--skyTop);font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  #app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto;
       background:linear-gradient(var(--skyTop),var(--skyMid) 60%,var(--grass1) 60%)}
  header{padding:.5rem max(12px,env(safe-area-inset-left)) .5rem max(12px,env(safe-area-inset-right));
         display:flex;gap:10px;align-items:center;justify-content:space-between;
         background:rgba(255,255,255,.45);backdrop-filter:blur(8px) saturate(1.2);
         border-bottom:1px solid rgba(0,0,0,.06)}
  .left{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{border:none;border-radius:9999px;padding:.45rem .75rem;font-weight:800;
        box-shadow:0 4px 12px rgba(0,0,0,.12);background:#fff;color:#111}
  .pill.toggle{background:var(--pillOff)} .pill.on{background:var(--pillOn);color:#fff}
  #scoreWrap{display:flex;align-items:center;gap:6px;background:#fff;border-radius:9999px;
             padding:.35rem .7rem;font-weight:800;box-shadow:0 4px 12px rgba(0,0,0,.12)}
  #scoreWrap .spark{opacity:0;transform:translateY(0);transition:opacity .2s,transform .2s}
  #scoreWrap.bump .spark{opacity:1;transform:translateY(-4px)}
  #stage{position:relative;display:grid;place-items:center}
  canvas{width:100vw;height:calc(100vh - 220px);max-height:75vh;touch-action:none;
         border-radius:12px;border:2px solid rgba(0,0,0,.06);box-shadow:0 10px 30px rgba(0,0,0,.15)}
  @media (min-aspect-ratio:4/3) and (min-width:900px){canvas{height:calc(100vh - 190px);max-height:80vh}}
  footer{padding:.5rem max(12px,env(safe-area-inset-left)) calc(.5rem + env(safe-area-inset-bottom)) max(12px,env(safe-area-inset-right));
         display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .bigbtn{font-size:clamp(14px,2.3vw,18px);padding:.8rem .7rem;border-radius:14px;background:#fff;
          box-shadow:0 10px 25px rgba(0,0,0,.18);border:2px solid rgba(0,0,0,.08);font-weight:800}
  .overlay{position:fixed;inset:0;display:grid;place-items:center;background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(255,255,255,.78));z-index:9999}
  .panel{background:#fff;border-radius:16px;padding:18px;border:1px solid rgba(0,0,0,.06);box-shadow:0 12px 30px rgba(0,0,0,.18);text-align:center;max-width:560px}
  .row{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-top:8px}
  .modebtn{border:none;border-radius:12px;padding:12px 14px;font-weight:800;background:#eef2ff}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="left">
      <div id="scoreWrap">‚≠ê <span id="score">0</span><span class="spark">+1</span></div>
      <button id="sound" class="pill toggle">üîä Sound</button>
      <button id="music" class="pill toggle">üéµ Music</button>
      <button id="mode" class="pill">üïπÔ∏è Mode: <span id="modeName">Points</span></button>
    </div>
    <div style="display:flex;gap:8px">
      <button id="pause" class="pill">‚è∏Ô∏è Pause</button>
      <button id="restart" class="pill">üîÅ Restart</button>
    </div>
  </header>

  <div id="stage"><canvas id="game" width="1400" height="720" aria-label="Food Frenzy"></canvas></div>

  <footer>
    <button id="btnJump" class="bigbtn">‚¨ÜÔ∏è Jump</button>
    <button id="btnDash" class="bigbtn">üí® Dash</button>
    <button id="btnSniff" class="bigbtn">üëÉ Sniff</button>
  </footer>
</div>

<!-- Start -->
<div id="startOverlay" class="overlay">
  <div class="panel">
    <h2>Beagle: Food Frenzy</h2>
    <p>Tap Start to enable audio on iPhone or iPad.</p>
    <div class="row">
      <button id="startBtn" class="modebtn">‚ñ∂Ô∏è Start with Sound</button>
      <button id="startMuted" class="modebtn">üîá Start Muted</button>
    </div>
  </div>
</div>

<!-- Mode chooser -->
<div id="modeOverlay" class="overlay" style="display:none">
  <div class="panel">
    <h2>Choose a Mode</h2>
    <div class="row">
      <button id="choosePoints" class="modebtn">üéØ Points</button>
      <button id="chooseEndless" class="modebtn">‚ôæÔ∏è Endless</button>
    </div>
  </div>
</div>

<script>
(() => {
/* ===== Canvas & UI ===== */
const cv = document.getElementById('game');
const ctx = cv.getContext('2d');
const scoreEl = document.getElementById('score');
const scoreWrap = document.getElementById('scoreWrap');
const soundBtn = document.getElementById('sound');
const musicBtn = document.getElementById('music');
const pauseBtn = document.getElementById('pause');
const restartBtn = document.getElementById('restart');
const startOverlay = document.getElementById('startOverlay');
const startBtn = document.getElementById('startBtn');
const startMuted = document.getElementById('startMuted');
const modeBtn = document.getElementById('mode');
const modeNameEl = document.getElementById('modeName');
const modeOverlay = document.getElementById('modeOverlay');
const choosePoints = document.getElementById('choosePoints');
const chooseEndless = document.getElementById('chooseEndless');
const btnJump = document.getElementById('btnJump');
const btnDash = document.getElementById('btnDash');
const btnSniff = document.getElementById('btnSniff');

/* ===== Orientation ===== */
function fit(){
  const dpr=Math.min(devicePixelRatio||1,2);
  const headerH=64, footerH=100;
  const h=Math.floor((innerHeight-headerH-footerH)*dpr), w=Math.floor(innerWidth*dpr);
  cv.width=Math.max(1000,Math.min(1920,w));
  cv.height=Math.max(520,Math.min(1080,h));
}
addEventListener('resize',fit);
addEventListener('orientationchange',()=>setTimeout(fit,250));
fit();

/* ===== Game State ===== */
const MODE={POINTS:'points',ENDLESS:'endless'};
let mode=MODE.POINTS; modeNameEl.textContent='Points';
modeBtn.addEventListener('click',()=>modeOverlay.style.display='grid');
choosePoints.addEventListener('click',()=>{mode=MODE.POINTS;modeNameEl.textContent='Points';reset(true);modeOverlay.style.display='none';});
chooseEndless.addEventListener('click',()=>{mode=MODE.ENDLESS;modeNameEl.textContent='Endless';reset(true);modeOverlay.style.display='none';});

let running=true, t=0, speed=6.2, score=0, shake=0;
let level=1, target=15, levelClearing=false, pooAnim=0;
const gravity=.62;

/* ===== Beagle (cartoony) ===== */
const dog={ x:260, y:0, vy:0, w:180, h:110, baseY:0, onGround:true,
  run:0, tilt:0, squash:0, frame:0, frameTimer:0, state:'run',
  dash:0, sniff:0
};

/* ===== Background ===== */
let clouds=makeClouds(), hills=makeHills(), grass=makeGrass();
function makeClouds(){ const a=[]; for(let i=0;i<6;i++) a.push({x:Math.random()*cv.width,y:30+Math.random()*cv.height*.35,r:20+Math.random()*40,s:.12+Math.random()*.28}); return a; }
function makeHills(){ return [{x:0,y:cv.height*.56,c:'#8BC34A',speed:.28,bumps:bumps(6,170,76)},{x:0,y:cv.height*.64,c:'#66BB6A',speed:.52,bumps:bumps(7,130,60)}]; }
function bumps(n,w,h){ const a=[]; for(let i=0;i<n;i++) a.push({w,h:h*(.6+Math.random()*.8)}); return a; }
function makeGrass(){ const a=[]; for(let i=0;i<120;i++) a.push({x:Math.random()*cv.width,s:Math.random()*Math.PI*2}); return a; }

/* ===== Food items ===== */
const FOOD_TYPES = [
  {name:'pizza',    w:40, h:36, val:[2,3], draw:(x,y)=>drawPizza(x,y)},
  {name:'sausages', w:44, h:26, val:[3,4], draw:(x,y)=>drawSausages(x,y)},
  {name:'chicken',  w:42, h:34, val:[4,5], draw:(x,y)=>drawChicken(x,y)}
];
let foods=[], spawnTimer=100;

/* ===== Audio ===== */
let ac=null, master=null, sfxOn=false, musicOn=false, musicTimer=null;
function ensureAudio(){ if(ac) return; const C=window.AudioContext||window.webkitAudioContext; ac=new C(); master=ac.createGain(); master.gain.value=.85; master.connect(ac.destination); }
function env(dur=0.2, peak=0.8){ const g=ac.createGain(); const now=ac.currentTime; g.gain.setValueAtTime(0.0001,now); g.gain.exponentialRampToValueAtTime(peak, now+0.01); g.gain.exponentialRampToValueAtTime(0.0001, now+dur); return {g,now}; }
function sfx_munch(){ if(!sfxOn) return; ensureAudio(); const {g,now}=env(0.14,0.5); const o=ac.createOscillator(); o.type='square'; o.frequency.value=320; o.connect(g); g.connect(master); o.start(now); o.stop(now+.12); }
function sfx_burp(){ if(!sfxOn) return; ensureAudio(); const {g,now}=env(0.3,0.35); const o=ac.createOscillator(); o.type='sawtooth'; o.frequency.setValueAtTime(180,now); o.frequency.exponentialRampToValueAtTime(90,now+.25); o.connect(g); g.connect(master); o.start(now); o.stop(now+.3); }
function sfx_whoosh(){ if(!sfxOn) return; ensureAudio(); const len=ac.sampleRate*0.18, buf=ac.createBuffer(1,len,ac.sampleRate), d=buf.getChannelData(0);
  let b0=0,b1=0,b2=0; for(let i=0;i<len;i++){ const white=Math.random()*2-1; b0=.99765*b0+white*0.0990460; b1=.96300*b1+white*0.2965164; b2=.57000*b2+white*1.0526913; d[i]=b0+b1+b2; }
  const src=ac.createBufferSource(); src.buffer=buf; const hp=ac.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=900;
  const {g,now}=env(0.2,0.4); src.connect(hp); hp.connect(g); g.connect(master); src.start(now);
}
function sfx_level(){ if(!sfxOn) return; ensureAudio(); const now=ac.currentTime, seq=[523.25,659.25,783.99,1046.5];
  seq.forEach((f,i)=>{ const o=ac.createOscillator(), g=ac.createGain(); o.type='triangle'; o.frequency.setValueAtTime(f, now+i*.08);
    g.gain.setValueAtTime(.0001, now+i*.08); g.gain.exponentialRampToValueAtTime(.28, now+i*.08+.02);
    g.gain.exponentialRampToValueAtTime(.0001, now+i*.08+.22); o.connect(g); g.connect(master); o.start(now+i*.08); o.stop(now+i*.08+.25); });
}
function sfx_plop(){ if(!sfxOn) return; ensureAudio(); const {g,now}=env(0.22,0.5); const o=ac.createOscillator(); o.type='square'; o.frequency.value=140; o.connect(g); g.connect(master); o.start(now); o.stop(now+.18); }
function toggleMusic(){ if(!musicOn){ ensureAudio(); const tempo=110, beat=60/tempo; let step=0;
    const bass=ac.createOscillator(), filt=ac.createBiquadFilter(), g=ac.createGain();
    bass.type='triangle'; filt.type='lowpass'; filt.frequency.value=900; g.gain.value=0.0; bass.connect(filt); filt.connect(g); g.connect(master); bass.start();
    const seq=[0,3,5,7,5,3,0,-2];
    function tick(){ if(!musicOn) return; const now=ac.currentTime; const n=seq[step%seq.length]; const f=110*Math.pow(2,n/12);
      filt.frequency.setValueAtTime(900+(step%4)*150, now);
      g.gain.cancelScheduledValues(now); g.gain.setValueAtTime(.0001, now); g.gain.exponentialRampToValueAtTime(.16, now+.01); g.gain.exponentialRampToValueAtTime(.0001, now+beat*.9);
      bass.frequency.setValueAtTime(f, now); step++; musicTimer=setTimeout(tick, beat*1000); }
    musicOn=true; musicBtn.classList.add('on'); musicBtn.textContent='üéµ Music On'; tick();
  } else { musicOn=false; musicBtn.classList.remove('on'); musicBtn.textContent='üéµ Music'; if(musicTimer) clearTimeout(musicTimer); } }
soundBtn.addEventListener('click',()=>{ ensureAudio(); if(ac.state==='suspended') ac.resume(); sfxOn=!sfxOn; soundBtn.classList.toggle('on',sfxOn); soundBtn.textContent=sfxOn?'üîä Sound On':'üîä Sound'; if(sfxOn) sfx_burp();});
musicBtn.addEventListener('click',toggleMusic);
startBtn.addEventListener('click',()=>{ ensureAudio(); ac.resume?.(); sfxOn=true; soundBtn.classList.add('on'); soundBtn.textContent='üîä Sound On'; sfx_burp(); startOverlay.style.display='none'; modeOverlay.style.display='grid'; });
startMuted.addEventListener('click',()=>{ startOverlay.style.display='none'; modeOverlay.style.display='grid'; });

/* ===== Controls ===== */
function pressJump(){ if(dog.onGround) { dog.vy=-23.5; dog.onGround=false; dog.state='jump'; sfx_whoosh(); } }
function pressDash(){ dog.dash=22; sfx_whoosh(); }
function pressSniff(){ dog.sniff=36; } // food magnet

btnJump.addEventListener('touchstart',e=>{e.preventDefault();pressJump();},{passive:false});
btnDash.addEventListener('touchstart',e=>{e.preventDefault();pressDash();},{passive:false});
btnSniff.addEventListener('touchstart',e=>{e.preventDefault();pressSniff();},{passive:false});

addEventListener('keydown',e=>{
  if(['ArrowUp','Space'].includes(e.code)) pressJump();
  else if(e.code==='KeyD') pressDash();
  else if(e.code==='KeyS') pressSniff();
  else if(e.code==='KeyP') togglePause();
});

pauseBtn.addEventListener('click',togglePause);
restartBtn.addEventListener('click',()=>reset(true));
function togglePause(){ running=!running; pauseBtn.textContent=running?'‚è∏Ô∏è Pause':'‚ñ∂Ô∏è Resume'; }

/* ===== Reset and levels ===== */
function reset(full=false){
  running=true; levelClearing=false; pooAnim=0; t=0; speed=6.2;
  if(full){ score=0; updateScore(0,true); level=1; target=randTarget(); }
  shake=0; clouds=makeClouds(); hills=makeHills(); grass=makeGrass();
  foods=[]; spawnTimer=70;
  Object.assign(dog,{ baseY:cv.height*.72, y:cv.height*.72, vy:0, onGround:true, run:0, tilt:0, squash:0, frame:0, frameTimer:0, state:'run', dash:0, sniff:0 });
}
function randTarget(){ return 12 + Math.floor(Math.random()*12); }
function levelUp(){
  level++; target = randTarget();
  speed += 0.22;
  sfx_level();
}

/* ===== Helpers ===== */
function rr(x,y,w,h,r,fill=true){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); fill?ctx.fill():ctx.stroke(); }
function rects(a,b){ return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }

/* ===== Background draw ===== */
function drawCloudsSun(){ const r=46; ctx.beginPath(); ctx.arc(cv.width-110,90,r,0,Math.PI*2); ctx.fillStyle='#FFD166'; ctx.fill();
  clouds.forEach(c=>{ c.x-=c.s; if(c.x<-160){ c.x=cv.width+160; c.y=30+Math.random()*cv.height*.35; } drawCloud(c.x,c.y,c.r);}); }
function drawCloud(x,y,r){ ctx.fillStyle='rgba(255,255,255,.96)'; ctx.beginPath();
  ctx.arc(x,y,r,0,Math.PI*2); ctx.arc(x+r,y+10,r*.8,0,Math.PI*2); ctx.arc(x-r,y+10,r*.85,0,Math.PI*2); ctx.arc(x,y+18,r*.9,0,Math.PI*2); ctx.fill(); }
function drawHills(){ const sh=shake?(Math.random()*shake-shake/2):0; ctx.save(); ctx.translate(0,sh);
  hills.forEach(L=>{ L.x-=L.speed*(speed*.6); if(L.x<-cv.width) L.x+=cv.width; const y=L.y; ctx.fillStyle=L.c;
    for(let k=0;k<2;k++){ const xo=L.x+k*cv.width; ctx.beginPath(); ctx.moveTo(xo,cv.height); let x=xo;
      for(const b of L.bumps){ ctx.bezierCurveTo(x+b.w*.3,y-b.h,x+b.w*.7,y+b.h*.2,x+b.w,y); x+=b.w; }
      ctx.lineTo(xo+cv.width,cv.height); ctx.closePath(); ctx.fill(); }});
  ctx.restore(); }
function drawGround(){ const gy=dog.baseY+26; ctx.fillStyle='#3aa64a'; ctx.fillRect(0,gy,cv.width,cv.height-gy);
  ctx.fillStyle='rgba(255,255,255,.8)'; ctx.fillRect(0,dog.baseY+4,cv.width,3);
  grass.forEach(g=>{ g.x-=speed*.9; if(g.x<-4) g.x=cv.width+Math.random()*40; const sw=Math.sin(t*.08+g.s)*4;
    ctx.strokeStyle='#2e7d32'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(g.x,gy); ctx.quadraticCurveTo(g.x+sw,gy-16,g.x+sw*.4,gy-28); ctx.stroke();}); }

/* ===== Beagle drawing ===== */
function drawBeagle(){
  dog.frameTimer++; const fps = dog.state==='run'?14 : 12;
  if(dog.frameTimer>=Math.max(2,Math.round(60/fps))){ dog.frameTimer=0; const max = dog.state==='run'?8:3; dog.frame=(dog.frame+1)%max; }

  const x=dog.x, y=dog.y, W=dog.w, H=dog.h;
  ctx.save(); ctx.translate(x,y); ctx.rotate(dog.tilt);

  // shadow
  ctx.fillStyle='rgba(0,0,0,.22)'; ctx.beginPath(); ctx.ellipse(0,H+16,Math.max(38,W*.64)*(dog.onGround?1:.7),12,0,0,Math.PI*2); ctx.fill();

  // body tri-colour
  const BLACK='#3b2f2f', TAN='#c7a072', WHITE='#fff';

  // torso
  ctx.fillStyle=BLACK; rr(-W*.05, H*.48, W*.74, H*.48, 28, true);
  ctx.beginPath(); ctx.ellipse(W*.18, H*.64, W*.22, H*.20, 0, 0, Math.PI*2); ctx.fill(); // hip
  ctx.beginPath(); ctx.ellipse(-W*.14, H*.54, W*.20, H*.18, 0, 0, Math.PI*2); ctx.fill(); // shoulder

  // belly white
  ctx.fillStyle=WHITE; rr(-W*.12, H*.60, W*.26, H*.32, 22, true);

  // legs simple
  function leg(xo,flip,front){
    const ph=(dog.frame/8)*Math.PI*2;
    const swing=Math.sin(ph+(flip?Math.PI:0))*18*(front?1:.9);
    ctx.save(); ctx.translate(xo, front?H*.62:H*.70); ctx.rotate((front?1:-.8)*swing*Math.PI/180);
    ctx.fillStyle=BLACK; rr(-6,0,12, front?32:26,5,true); ctx.translate(0,front?30:22); ctx.rotate((-swing*.5)*Math.PI/180);
    rr(-5,0,10, front?24:20,4,true); ctx.fillStyle=WHITE; rr(-6,front?18:14,12,8,3,true); ctx.restore();
  }
  leg(-W*.24,false,true); leg(-W*.04,true,true);
  leg(W*.12,true,false);  leg(W*.30,false,false);

  // tail
  const wag=(dog.state==='run'?Math.sin(t*.30)*.55:Math.sin(t*.18)*.38);
  ctx.save(); ctx.translate(-W*.50, H*.56); ctx.rotate(wag);
  ctx.lineWidth=7; ctx.strokeStyle=BLACK; ctx.beginPath(); ctx.moveTo(0,0); ctx.quadraticCurveTo(-W*.22,-16,-W*.06,-28); ctx.stroke();
  ctx.strokeStyle=WHITE; ctx.lineWidth=5; ctx.beginPath(); ctx.moveTo(-W*.10,-20); ctx.lineTo(-W*.06,-28); ctx.stroke();
  ctx.restore();

  // neck and head
  ctx.fillStyle=TAN; rr(W*.18, H*.38, W*.22, H*.18, 10, true);
  const headW=W*.36, headH=H*.28;
  ctx.save(); ctx.translate(W*.42, H*.30 + Math.sin(t*.20)*1.0);
  ctx.fillStyle=TAN; rr(-headW*.85,-headH*.78, headW*1.8, headH*1.55, headW*.30, true);
  ctx.fillStyle=WHITE; rr(-3,-headH*.70,7,headH*1.40,3.5,true); // blaze
  ctx.fillStyle='#111'; ctx.beginPath(); ctx.ellipse(headW*.50, headH*.10, 4,3,0,0,Math.PI*2); ctx.fill(); // nose
  ctx.fillStyle='#000'; ctx.beginPath(); ctx.ellipse(headW*.06, -headH*.12, 4.2,3.2, 0.25, 0, Math.PI*2); ctx.fill(); // eye
  ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(headW*.08, -headH*.135, 1.1, 0, Math.PI*2); ctx.fill(); // eye highlight
  // floppy ears
  ctx.fillStyle=BLACK;
  ctx.save(); ctx.translate(-headW*.02,-headH*.30);
  rr(-headW*.02,-headH*.05, headW*.30, headH*.40, 12, true);
  ctx.restore();
  ctx.save(); ctx.translate(headW*.10,-headH*.34); ctx.rotate(0.05);
  rr(-headW*.02,-headH*.05, headW*.28, headH*.38, 12, true);
  ctx.restore();
  ctx.restore(); // head

  ctx.restore();
}

/* ===== Food drawing ===== */
function drawPizza(x,y){
  ctx.save(); ctx.translate(x,y);
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(20,34); ctx.lineTo(-20,34); ctx.closePath();
  ctx.fillStyle='#ffcc80'; ctx.fill();
  ctx.fillStyle='#d84315'; ctx.fillRect(-16,20,32,6); // sauce hint
  ctx.fillStyle='#ffeb3b'; ctx.fillRect(-18,16,36,6); // cheese hint
  ctx.fillStyle='#8d6e63'; for(let i=-10;i<=10;i+=10){ ctx.beginPath(); ctx.arc(i,24,3,0,Math.PI*2); ctx.fill(); } // toppings
  ctx.restore();
}
function drawSausages(x,y){
  ctx.save(); ctx.translate(x,y);
  ctx.fillStyle='#d84315';
  for(let k=-1;k<=1;k++){
    ctx.beginPath(); ctx.ellipse(k*10,24,13,6,0,0,Math.PI*2); ctx.fill();
  }
  ctx.restore();
}
function drawChicken(x,y){
  ctx.save(); ctx.translate(x,y);
  // drumstick
  ctx.fillStyle='#a35d2f'; ctx.beginPath(); ctx.ellipse(0,24,16,12,0,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.ellipse(14,24,10,8,0,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#f5deb3'; ctx.beginPath(); ctx.ellipse(22,24,6,6,0,0,Math.PI*2); ctx.fill(); // bone knob
  ctx.restore();
}

/* ===== Poo animation ===== */
function drawPoo(x,y,prog){
  // prog 0 to 1
  const r=8+prog*2;
  ctx.save(); ctx.translate(x,y);
  ctx.fillStyle='#6d4c41'; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(0,-r*.6,r*.7,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(0,-r*1.2,r*.45,0,Math.PI*2); ctx.fill();
  // stink lines
  ctx.strokeStyle='rgba(120,90,60,.6)'; ctx.lineWidth=2;
  for(let i=-1;i<=1;i++){
    ctx.beginPath(); ctx.moveTo(i*8,-r*1.8); ctx.quadraticCurveTo(i*8-3,-r*2.6,i*8,-r*3.2); ctx.stroke();
  }
  ctx.restore();
}

/* ===== Update ===== */
function update(){
  if(!running) return;
  t++; speed+=0.0008; if(shake>0) shake--;
  if(dog.dash>0) dog.dash--; if(dog.sniff>0) dog.sniff--;

  // spawn food
  spawnTimer--;
  if(spawnTimer<=0){
    spawnFood();
    const minGap=90, maxGap=160, rnd=Math.floor(minGap+Math.random()*(maxGap-minGap));
    spawnTimer = rnd + Math.max(0,120-speed*8) | 0;
  }
  foods.forEach(f=>{ f.x -= speed * (1 + (dog.dash?0.45:0)); f.bob += 0.18; f.y = f.baseY + Math.sin(f.bob)*6; });

  // physics
  if(!dog.onGround) dog.vy += gravity;
  dog.y += dog.vy;
  if(dog.y >= dog.baseY){
    if(!dog.onGround){ dog.y=dog.baseY; dog.vy=0; dog.onGround=true; dog.state='run'; }
    dog.y=dog.baseY;
  } else dog.onGround=false;

  dog.tilt = dog.onGround ? Math.sin(t*.06)*.02 : (dog.vy<0 ? -0.07 : 0.06);

  // sniff magnet
  if(dog.sniff>0){
    foods.forEach(f=>{
      const dx = dog.x - f.x, dy = (dog.y - 10) - f.y;
      const d2 = dx*dx + dy*dy;
      if(d2 < 200*200){ f.x += dx*0.02; f.y += dy*0.02; }
    });
  }

  // eat
  const hb = { x:dog.x - dog.w*0.30, y:dog.y - dog.h*0.34, w:dog.w*0.60, h:dog.h*0.50 };
  for(let i=foods.length-1;i>=0;i--){
    const f=foods[i];
    const fb={x:f.x-f.w*0.5,y:f.y-f.h*0.5,w:f.w,h:f.h};
    if(rects(hb,fb)){
      const val = f.points;
      foods.splice(i,1);
      sfx_munch();
      addScore(val);
      if(mode===MODE.POINTS && score >= target && !levelClearing){
        levelClearing=true;
        pooAnim=1; // start
        sfx_plop();
        setTimeout(()=>{ // short celebration then next level
          levelClearing=false;
          levelUp();
        }, 1100);
      }
    }
  }

  // clean off-screen
  foods = foods.filter(f=>f.x > -60);

  // gentle speed increase
}

/* ===== Draw ===== */
function draw(){
  ctx.clearRect(0,0,cv.width,cv.height);
  drawCloudsSun(); drawHills(); drawGround();

  // foods
  foods.forEach(f=>{
    // shadow
    ctx.fillStyle='rgba(0,0,0,.18)';
    ctx.beginPath(); ctx.ellipse(f.x, dog.baseY+20, Math.max(18,f.w*.6), 8, 0, 0, Math.PI*2); ctx.fill();
    f.draw(f.x, f.y);
  });

  // poo at level end
  if(levelClearing && pooAnim>0){
    pooAnim = Math.min(1, pooAnim + 0.06);
    drawPoo(dog.x+40, dog.baseY+6, pooAnim);
  }

  drawBeagle();

  if(mode===MODE.POINTS){
    ctx.fillStyle='rgba(255,255,255,.9)'; ctx.fillRect(14,14,220,60);
    ctx.strokeStyle='rgba(0,0,0,.06)'; ctx.strokeRect(14,14,220,60);
    ctx.fillStyle='#113'; ctx.font='bold 18px -apple-system,system-ui'; ctx.fillText(`Level ${level}`,24,38); ctx.fillText(`Target: ${target}`,24,62);
    const pct=Math.min(1,score/target); ctx.fillStyle='rgba(11,61,32,.1)'; ctx.fillRect(130,28,90,12);
    ctx.fillStyle='#00c853'; ctx.fillRect(130,28,Math.floor(90*pct),12); ctx.strokeStyle='rgba(0,0,0,.12)'; ctx.strokeRect(130,28,90,12);
  }
}

/* ===== Food helpers ===== */
function spawnFood(){
  const type = FOOD_TYPES[(Math.random()*FOOD_TYPES.length)|0];
  const x = cv.width + 40;
  const yBase = dog.baseY - (70 + Math.random()*50);
  const points = randInt(type.val[0], type.val[1]);
  foods.push({type:type.name, x, y:yBase, baseY:yBase, w:type.w, h:type.h, draw:type.draw, bob:Math.random()*Math.PI*2, points});
}
function randInt(a,b){ return a + Math.floor(Math.random()*(b-a+1)); }

/* ===== Runtime helpers ===== */
function loop(){ if(running){ update(); } draw(); requestAnimationFrame(loop); }
function addScore(delta){
  score+=delta; scoreEl.textContent=String(score);
  scoreWrap.classList.remove('bump'); void scoreWrap.offsetWidth; scoreWrap.classList.add('bump');
  setTimeout(()=>scoreWrap.classList.remove('bump'),180);
}

/* ===== Start ===== */
function togglePause(){ running=!running; pauseBtn.textContent=running?'‚è∏Ô∏è Pause':'‚ñ∂Ô∏è Resume'; }
reset(true); loop();

})();
</script>
</body>
</html>
